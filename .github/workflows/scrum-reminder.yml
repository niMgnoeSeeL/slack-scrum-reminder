name: Scrum DM reminders

on:
  workflow_dispatch:
    inputs:
      test_message:
        description: "Send a one-off test DM"
        required: false
        default: "Test: Slack DM from GitHub Actions ✅"

  # GitHub cron은 UTC 기준
  # LA(PST, UTC-8) 기준 전날 1pm = 21:00 UTC
  schedule:
    - cron: "0 21 * * 1"  # Mon 1pm -> Tue 1:45pm scrum
    - cron: "0 21 * * 3"  # Wed 1pm -> Thu 1:45pm scrum
    - cron: "0 21 * * 4"  # Thu 1pm -> Fri 12:00pm scrum

jobs:
  dm:
    runs-on: ubuntu-latest

    steps:
      - name: Decide message
        id: msg
        run: |
          export TZ="America/Los_Angeles"
          TODAY_DOW=$(date +%a)

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "text=${{ github.event.inputs.test_message }}" >> $GITHUB_OUTPUT
            exit 0
          fi

          if [ "$TODAY_DOW" = "Mon" ]; then
            echo "text=Reminder for scrum tomorrow at 1:45 pm." >> $GITHUB_OUTPUT
          elif [ "$TODAY_DOW" = "Wed" ]; then
            echo "text=Reminder for scrum tomorrow at 1:45 pm." >> $GITHUB_OUTPUT
          elif [ "$TODAY_DOW" = "Thu" ]; then
            echo "text=Reminder for scrum tomorrow at 12:00 pm." >> $GITHUB_OUTPUT
          else
            echo "text=" >> $GITHUB_OUTPUT
          fi

      - name: Send DM via Slack API
        if: steps.msg.outputs.text != ''
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_USER_ID: ${{ secrets.SLACK_USER_ID }}
          TEXT: ${{ steps.msg.outputs.text }}
        run: |
          RESPONSE=$(curl -sS -X POST "https://slack.com/api/chat.postMessage" \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -H "Content-type: application/json; charset=utf-8" \
            --data "{\"channel\":\"$SLACK_USER_ID\",\"text\":\"$TEXT\"}")

          echo "Slack response:"
          echo "$RESPONSE"
