name: Scrum reminders (DST-safe)

on:
  workflow_dispatch:
    inputs:
      test_message:
        description: "Send a one-off test reminder (DM + channel)"
        required: false
        default: "Test: scrum reminder âœ…"

  # DST-safe: ë§¤ì‹œê°„ ëŒë¦¬ê³  LA ì‹œê°„ì´ 1pmì¼ ë•Œë§Œ ë³´ëƒ„
  schedule:
    - cron: "0 * * * *"

jobs:
  remind:
    runs-on: ubuntu-latest

    steps:
      - name: Decide message (LA time gate)
        id: msg
        run: |
          # LA ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ "ì§€ê¸ˆì´ 1pmì¸ì§€" ì²´í¬
          export TZ="America/Los_Angeles"

          # ìˆ˜ë™ ì‹¤í–‰ì´ë©´ ìž…ë ¥ ë©”ì‹œì§€ ê·¸ëŒ€ë¡œ ì „ì†¡
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "text=${{ github.event.inputs.test_message }}" >> $GITHUB_OUTPUT
            exit 0
          fi

          HOUR=$(date +%H)   # 00-23
          DOW=$(date +%a)    # Mon/Tue/Wed/Thu/Fri/Sat/Sun

          # 1pm(13:00) ì•„ë‹ˆë©´ ì•„ë¬´ ê²ƒë„ ì•ˆ ë³´ëƒ„
          if [ "$HOUR" != "13" ]; then
            echo "text=" >> $GITHUB_OUTPUT
            exit 0
          fi

          # ì „ë‚  1pmì— ë³´ë‚¼ ìš”ì¼:
          # Mon 1pm -> Tue scrum(1:45pm)
          # Wed 1pm -> Thu scrum(1:45pm)
          # Thu 1pm -> Fri scrum(12:00pm)
          if [ "$DOW" = "Mon" ]; then
            echo "text=ðŸ“£ Reminder: In-person scrum tomorrow @ 1:45 pm." >> $GITHUB_OUTPUT
          elif [ "$DOW" = "Wed" ]; then
            echo "text=ðŸ“£ Reminder: In-person scrum tomorrow @ 1:45 pm." >> $GITHUB_OUTPUT
          elif [ "$DOW" = "Thu" ]; then
            echo "text=ðŸ“£ Reminder: In-person scrum tomorrow @ 12:00 pm." >> $GITHUB_OUTPUT
          else
            echo "text=" >> $GITHUB_OUTPUT
          fi

      - name: Send DM
        if: steps.msg.outputs.text != ''
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_USER_ID: ${{ secrets.SLACK_USER_ID }}
          TEXT: ${{ steps.msg.outputs.text }}
        run: |
          RESPONSE=$(curl -sS -X POST "https://slack.com/api/chat.postMessage" \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -H "Content-type: application/json; charset=utf-8" \
            --data "{\"channel\":\"$SLACK_USER_ID\",\"text\":\"$TEXT\"}")

          echo "DM response:"
          echo "$RESPONSE"

      - name: Post to scrum channel
        if: steps.msg.outputs.text != ''
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
          TEXT: ${{ steps.msg.outputs.text }}
        run: |
          RESPONSE=$(curl -sS -X POST "https://slack.com/api/chat.postMessage" \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -H "Content-type: application/json; charset=utf-8" \
            --data "{\"channel\":\"$SLACK_CHANNEL_ID\",\"text\":\"$TEXT\"}")

          echo "Channel response:"
          echo "$RESPONSE"
